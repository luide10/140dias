<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA: Configura√ß√µes para iOS (iPhone) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Desafio 140">

    <!-- PWA: Configura√ß√µes para Android (Manifesto Embutido) -->
    <link rel="manifest" href='data:application/manifest+json,{
        "name": "Desafio 140 Dias",
        "short_name": "Desafio 5k",
        "start_url": ".",
        "display": "standalone",
        "orientation": "portrait",
        "background_color": "#e8f5e9",
        "theme_color": "#00c853",
        "icons": [{
            "src": "https://cdn-icons-png.flaticon.com/512/2830/2830284.png",
            "sizes": "512x512",
            "type": "image/png"
        }]
    }'>

    <meta name="theme-color" content="#00c853">

    <title>Desafio 5k - Pir√¢mide</title>
    <!-- Fonte Moderna -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- DESIGN SYSTEM MODERNO (CSS) --- */
        :root {
            /* Paleta de Cores Vibrante */
            --primary-gradient: linear-gradient(135deg, #00c853 0%, #64dd17 100%);
            --bg-gradient: linear-gradient(180deg, #e8f5e9 0%, #ffffff 100%);
            --card-shadow: 0 10px 30px -10px rgba(0, 100, 0, 0.15);
            --text-main: #1b5e20;
            --text-sec: #4caf50;
            
            /* Status Colors */
            --facil: #a5d6a7;
            --medio: #90caf9;
            --dificil: #ce93d8;
            
            --pago-gradient: linear-gradient(135deg, #ff5252 0%, #d32f2f 100%);
        }

        /* CORRE√á√ÉO GLOBAL DE LAYOUT - ISSO RESOLVE O "CORTADO" */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-gradient);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 15px; /* Ajustado para mobile */
            margin: 0;
            color: #333;
            min-height: 100vh;
            -webkit-user-select: none;
            user-select: none;
            overflow-x: hidden;
            width: 100%;
        }

        input { user-select: text; -webkit-user-select: text; }

        .app-header {
            text-align: center;
            margin-bottom: 20px;
            animation: fadeInDown 0.8s ease;
            width: 100%;
        }

        h1 { 
            color: var(--text-main); 
            margin: 5px 0; 
            font-size: 1.8rem; 
            font-weight: 800;
            letter-spacing: -0.5px;
        }
        
        .subtitle {
            font-size: 0.9rem;
            color: var(--text-sec);
            font-weight: 500;
        }

        .placar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px); 
            padding: 25px 20px; /* Ajuste padding interno */
            border-radius: 24px;
            box-shadow: 0 15px 40px rgba(0, 50, 0, 0.15);
            margin-bottom: 30px;
            text-align: center;
            width: 100%;
            max-width: 500px;
            position: sticky;
            top: 15px;
            z-index: 100;
            border: 1px solid rgba(255,255,255,0.6);
            transition: transform 0.3s ease;
        }

        .valor-total { 
            font-size: 3em; 
            font-weight: 800; 
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 5px 0 15px 0;
            letter-spacing: -1px;
            filter: drop-shadow(0 2px 4px rgba(0,200,83,0.2));
            line-height: 1.2;
        }

        .progress-bar-container { 
            width: 100%; 
            height: 22px; 
            background-color: #eaeff2; 
            border-radius: 50px; 
            overflow: hidden; 
            margin-bottom: 15px; 
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.15), 0 1px 2px rgba(255,255,255,0.8);
            position: relative;
            border: 1px solid rgba(0,0,0,0.03);
        }
        
        .progress-bar-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #00e676, #00c853);
            width: 0%; 
            transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-radius: 50px;
            position: relative;
            box-shadow: 2px 0 10px rgba(0,200,83,0.4);
        }

        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 2px; left: 5px; right: 5px; height: 40%;
            background: linear-gradient(180deg, rgba(255,255,255,0.7) 0%, rgba(255,255,255,0.1) 100%);
            border-radius: 50px;
            opacity: 0.8;
        }

        #progressoTexto {
            font-size: 0.85em;
            color: #666;
            font-weight: 700;
            background: white;
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-top: 5px;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); /* Reduzi minmax para caber melhor */
            gap: 12px;
            width: 100%;
            max-width: 900px;
            padding-bottom: 30px;
        }

        .section-title {
            grid-column: 1 / -1;
            margin-top: 40px;
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 700;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: space-between; /* Espalha t√≠tulo e bot√£o */
            flex-wrap: wrap; /* Permite quebrar linha se n√£o couber */
            gap: 10px;
        }
        
        /* Bot√£o pequeno de limpar se√ß√£o */
        .btn-mini-clear {
            background: none;
            border: 1px solid #ffcdd2;
            color: #e57373;
            font-size: 0.75em;
            padding: 5px 12px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .btn-mini-clear:hover {
            background: #ffebee;
            color: #c62828;
            border-color: #ef9a9a;
        }

        .card {
            background-color: white;
            border-radius: 18px;
            padding: 15px 5px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-weight: 700;
            font-size: 1rem;
            color: #555;
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
        }

        .card:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
        .card:active { transform: scale(0.95); }

        .facil { background-color: #f1f8e9; color: #33691e; }
        .medio { background-color: #e3f2fd; color: #0d47a1; }
        .dificil { background-color: #f3e5f5; color: #4a148c; }

        .card.pago {
            background: var(--pago-gradient) !important;
            color: white !important;
            box-shadow: 0 5px 15px rgba(211, 47, 47, 0.4);
            border: none;
            text-decoration: line-through;
            opacity: 0.9;
            transform: scale(0.95);
        }
        
        .centro-tela {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-gradient);
            z-index: 2000;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 20px;
            width: 100%;
        }

        .card-branco {
            background: white;
            padding: 40px 25px; /* Ajuste padding lateral */
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 380px;
            width: 100%;
            position: relative;
        }
        
        .login-icon {
            font-size: 3rem;
            margin-bottom: 10px;
            display: block;
        }

        .input-texto {
            width: 100%; /* Largura total do container */
            padding: 16px;
            margin: 12px 0;
            border: 2px solid #f0f0f0;
            border-radius: 16px;
            font-size: 1rem;
            text-align: center;
            outline: none;
            transition: all 0.3s;
            background: #fafafa;
            font-family: inherit;
        }
        .input-texto:focus { 
            border-color: #00c853; 
            background: white;
            box-shadow: 0 0 0 4px rgba(0, 200, 83, 0.1);
        }

        .btn-row { display: flex; gap: 15px; width: 100%; margin-top: 20px; justify-content: center; }

        .btn-base {
            padding: 16px 0;
            font-size: 1em;
            border-radius: 16px;
            cursor: pointer;
            font-weight: 700;
            transition: transform 0.2s, box-shadow 0.2s;
            flex: 1; border: none;
            font-family: inherit;
        }
        
        .btn-entrar {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 200, 83, 0.3);
        }
        .btn-entrar:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 200, 83, 0.4); }

        .btn-cadastrar {
            background: white;
            color: #2196f3;
            border: 2px solid #e3f2fd;
        }
        .btn-cadastrar:hover { background: #e3f2fd; }

        .btn-secundario {
            background: none; border: none; color: #999;
            text-decoration: none; font-weight: 600; font-size: 0.9em;
            margin-top: 30px; cursor: pointer;
            padding: 10px 20px; border-radius: 50px;
            transition: background 0.2s;
        }
        .btn-secundario:hover { background: #f0f0f0; color: #555; }

        .btn-danger {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
            margin-top: 15px;
            width: 100%;
            max-width: 300px;
            padding: 15px;
            border-radius: 16px;
            cursor: pointer;
            font-weight: 700;
            font-family: inherit;
        }
        .btn-danger:hover { background: #ef9a9a; color: white; }

        .btn-fix {
            background: #ffecb3; 
            color: #ff6f00; 
            border: 2px solid #ffca28;
            margin-top: 15px;
            display: none; 
        }
        .btn-fix:hover { background: #ffe082; }

        .loading-spinner {
            width: 40px; height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #00c853;
            border-radius: 50%;
            margin: 20px auto;
            animation: spin 1s linear infinite;
            display: none;
        }
        
        .user-badge {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 8px 20px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.9em;
            margin-bottom: 20px;
            display: inline-block;
        }

        #error-box {
            display: none;
            background-color: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 16px;
            border: none;
            margin-bottom: 20px;
            max-width: 500px;
            text-align: left;
            line-height: 1.6;
            box-shadow: 0 5px 15px rgba(198, 40, 40, 0.1);
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 480px) {
            .valor-total { font-size: 2.5em; }
            .card { padding: 15px 5px; font-size: 1em; }
        }
    </style>
</head>
<body>

    <div id="error-box">
        <h3>‚ö†Ô∏è Aten√ß√£o</h3>
        <p id="error-message">Erro desconhecido.</p>
    </div>

    <!-- TELA 1: LOGIN -->
    <div id="login-screen" class="centro-tela">
        <div class="card-branco">
            <span class="login-icon">üèîÔ∏è</span>
            <h2 style="color: #333; margin-top: 0;">Jornada 5k</h2>
            <p style="color: #666; font-size: 0.95em;">Escale a montanha da economia.</p>
            
            <input type="text" id="profileInput" class="input-texto" placeholder="Seu Usu√°rio" autocomplete="off">
            <input type="password" id="passwordInput" class="input-texto" placeholder="Sua Senha" autocomplete="off">
            
            <div id="loading" class="loading-spinner"></div>
            
            <div id="btnContainer" class="btn-row">
                <button class="btn-base btn-entrar" onclick="fazerLogin()">Entrar</button>
                <button class="btn-base btn-cadastrar" onclick="criarConta()">Criar</button>
            </div>
            
            <p style="font-size:0.75em; color:#bbb; margin-top:25px; margin-bottom: 0;">Sincronizado na nuvem ‚òÅÔ∏è</p>
        </div>
    </div>

    <!-- TELA 2: DASHBOARD -->
    <div id="dashboard-screen" style="display: none;">
        
        <div class="app-header">
            <h1>Jornada 5k</h1>
            <p class="subtitle">Subindo a montanha! üßó</p>
        </div>

        <div class="user-badge" id="userBadge">Ol√°, ...</div>
        
        <!-- Bot√£o de corre√ß√£o de dados (Aparece se detectar vers√£o antiga) -->
        <div id="fixDataContainer" style="width: 100%; max-width: 500px; display: none; margin-bottom: 20px;">
            <button class="btn-base btn-fix" onclick="resetarParaPiramide()">
                üîÑ Atualizar para Pir√¢mide (Corrige o Bug)
            </button>
            <p style="font-size: 0.8em; color: #ff6f00; text-align: center; margin-top: 5px;">
                Isso vai resetar seus valores para o novo formato.
            </p>
        </div>
        
        <div class="placar">
            <div style="font-size: 0.8em; text-transform: uppercase; letter-spacing: 1px; color: #888; font-weight: 700;">Voc√™ j√° guardou</div>
            <div class="valor-total" id="displayTotal">R$ 0,00</div>
            
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="barraProgresso"></div>
            </div>
            <div id="progressoTexto" style="font-size: 0.9em; color: #666; font-weight: 600;">Carregando...</div>
        </div>

        <div class="grid-container" id="grid"></div>

        <button class="btn-base btn-danger" onclick="limparTudo()">üóëÔ∏è Limpar Todo o Progresso</button>
        <button class="btn-secundario" onclick="sairPerfil()" style="margin-bottom: 40px;">Sair / Trocar Conta</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCYJjFkB_Xp8BkkM8WVA7l7i7DTf_ZDZFA",
            authDomain: "dias-e3c5a.firebaseapp.com",
            projectId: "dias-e3c5a",
            storageBucket: "dias-e3c5a.firebasestorage.app",
            messagingSenderId: "829637746364",
            appId: "1:829637746364:web:ba00ffee4e789f6d1afab9"
        };

        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase conectado.");
        } catch (e) {
            console.error("Erro config:", e);
            mostrarErro("Erro na configura√ß√£o interna do App. Verifique o console.");
        }

        let perfilAtual = null;
        let dadosDesafio = [];
        let unsubscribe = null;
        const VERSAO_ATUAL = 'piramide_v2'; // Controle de vers√£o para for√ßar atualiza√ß√£o

        const loginScreen = document.getElementById('login-screen');
        const dashboardScreen = document.getElementById('dashboard-screen');
        const loading = document.getElementById('loading');
        const btnContainer = document.getElementById('btnContainer');
        const errorBox = document.getElementById('error-box');
        const fixDataContainer = document.getElementById('fixDataContainer');

        function mostrarErro(mensagem) {
            errorBox.style.display = 'block';
            document.getElementById('error-message').innerHTML = mensagem;
            loginScreen.style.zIndex = '3000';
            loading.style.display = 'none';
            btnContainer.style.display = 'flex';
        }

        function alternarLoading(ativar) {
            if (ativar) {
                btnContainer.style.display = 'none';
                loading.style.display = 'block';
                errorBox.style.display = 'none';
            } else {
                btnContainer.style.display = 'flex';
                loading.style.display = 'none';
            }
        }

        window.fazerLogin = async function() {
            const nomeInput = document.getElementById('profileInput').value.trim().toLowerCase();
            const senhaInput = document.getElementById('passwordInput').value.trim();

            if (!nomeInput) return alert("Digite o usu√°rio.");
            if (!senhaInput) return alert("Digite a senha.");

            alternarLoading(true);
            perfilAtual = nomeInput;

            try {
                await signInAnonymously(auth);
                const docRef = doc(db, 'perfis', perfilAtual);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    alert("Usu√°rio n√£o encontrado! Verifique o nome ou crie uma conta nova.");
                    alternarLoading(false);
                    return;
                }

                const data = docSnap.data();
                if (data.senha && data.senha !== senhaInput) {
                    alert("Senha incorreta!");
                    alternarLoading(false);
                    return;
                }

                iniciarApp(docRef);

            } catch (error) {
                console.error("Erro Login:", error);
                tratarErroGeral(error);
            }
        };

        window.criarConta = async function() {
            const nomeInput = document.getElementById('profileInput').value.trim().toLowerCase();
            const senhaInput = document.getElementById('passwordInput').value.trim();

            if (!nomeInput) return alert("Escolha um nome de usu√°rio.");
            if (!senhaInput) return alert("Crie uma senha.");
            if (senhaInput.length < 6) return alert("A senha deve ter no m√≠nimo 6 caracteres.");

            alternarLoading(true);
            perfilAtual = nomeInput;

            try {
                await signInAnonymously(auth);
                const docRef = doc(db, 'perfis', perfilAtual);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    alert("Este nome de usu√°rio j√° existe! Por favor, escolha outro.");
                    alternarLoading(false);
                    return;
                }

                criarDadosPadrao();
                await setDoc(docRef, { 
                    items: dadosDesafio, 
                    senha: senhaInput,
                    layout: VERSAO_ATUAL,
                    criadoEm: new Date().toISOString() 
                });

                iniciarApp(docRef);

            } catch (error) {
                console.error("Erro Cadastro:", error);
                tratarErroGeral(error);
            }
        };

        function iniciarApp(docRef) {
            unsubscribe = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    dadosDesafio = data.items || [];
                    
                    // Verifica se os dados s√£o antigos
                    if (data.layout !== VERSAO_ATUAL) {
                        fixDataContainer.style.display = 'block'; 
                    } else {
                        fixDataContainer.style.display = 'none';
                    }

                    abrirDashboard();
                }
            }, (error) => {
                console.error("Erro no Listener:", error);
            });
        }

        window.resetarParaPiramide = async function() {
            if(confirm("Isso vai reiniciar seu progresso para aplicar o novo formato Pir√¢mide. Continuar?")) {
                criarDadosPadrao();
                const docRef = doc(db, 'perfis', perfilAtual);
                await updateDoc(docRef, { 
                    items: dadosDesafio,
                    layout: VERSAO_ATUAL 
                });
                alert("Atualizado com sucesso!");
            }
        }

        // Fun√ß√µes de limpeza
        window.limparIntervalo = function(inicio, fim) {
            if(confirm("Tem certeza que quer limpar apenas esta se√ß√£o?")) {
                for(let i=inicio; i<fim; i++) {
                    dadosDesafio[i].pago = false;
                }
                salvarProgresso();
            }
        }

        window.limparTudo = function() {
            if(confirm("ATEN√á√ÉO: Isso vai apagar todo o dinheiro marcado. Tem certeza?")) {
                dadosDesafio.forEach(item => item.pago = false);
                salvarProgresso();
            }
        }

        function tratarErroGeral(error) {
            alternarLoading(false);
            if(error.code === 'permission-denied') {
                mostrarErro(`<strong>ACESSO NEGADO:</strong> Banco bloqueado. V√° no console do Firebase > Firestore > Regras e mude para 'true'.`);
            } else if(error.code === 'auth/operation-not-allowed') {
                mostrarErro(`<strong>LOGIN BLOQUEADO:</strong> Ative o login An√¥nimo no Firebase.`);
            } else if(error.code === 'auth/unauthorized-domain') {
                mostrarErro(`<strong>DOM√çNIO BLOQUEADO:</strong> Adicione o dom√≠nio atual no Firebase Authentication.`);
            } else {
                mostrarErro("Erro: " + error.code);
            }
        }

        function abrirDashboard() {
            loginScreen.style.display = 'none';
            dashboardScreen.style.display = 'flex'; 
            const nomeFormatado = perfilAtual.charAt(0).toUpperCase() + perfilAtual.slice(1);
            document.getElementById('userBadge').textContent = `üëã Ol√°, ${nomeFormatado}`;
            renderizar();
        }

        // --- L√ìGICA DA PIR√ÇMIDE (V2) ---
        function criarDadosPadrao() {
            dadosDesafio = [];
            
            // 1. F√°cil (1 a 30) - 30 itens
            for(let i=1; i<=30; i++) dadosDesafio.push({ valor: i, tipo: 'facil', pago: false });
            
            // 2. M√©dio (31 a 48) - 18 itens
            for(let i=31; i<=48; i++) dadosDesafio.push({ valor: i, tipo: 'medio', pago: false });
            
            // 3. Dif√≠cil IDA (49 a 71) - 23 itens
            for(let i=49; i<=71; i++) dadosDesafio.push({ valor: i, tipo: 'dificil', pago: false });
            
            // 4. Dif√≠cil VOLTA (70 a 49) - 22 itens
            for(let i=70; i>=49; i--) dadosDesafio.push({ valor: i, tipo: 'dificil', pago: false });
            
            // 5. M√©dio VOLTA (48 a 31) - 18 itens
            for(let i=48; i>=31; i--) dadosDesafio.push({ valor: i, tipo: 'medio', pago: false });
            
            // 6. F√°cil VOLTA (30 a 1) - 30 itens (AGORA VAI AT√â 1)
            for(let i=30; i>=1; i--) dadosDesafio.push({ valor: i, tipo: 'facil', pago: false });
            
            // Total: 30 + 18 + 23 + 22 + 18 + 30 = 141 itens
        }

        function salvarProgresso() {
            const docRef = doc(db, 'perfis', perfilAtual);
            updateDoc(docRef, { items: dadosDesafio });
        }

        function renderizar() {
            const grid = document.getElementById('grid');
            grid.innerHTML = ''; 
            
            let totalGuardado = 0;
            let diasPagos = 0;
            
            // Total calculado dinamicamente com base na nova pir√¢mide (141)
            const totalDias = 141;

            const grupos = [
                { titulo: 'üü¢ N√≠vel F√°cil (Ida)', range: [0, 30] },
                { titulo: 'üîµ N√≠vel M√©dio (Ida)', range: [30, 48] },
                { titulo: 'üü£ N√≠vel Dif√≠cil (O Pico)', range: [48, 93] }, // Juntei Ida e Volta do Dif√≠cil
                { titulo: 'üîµ N√≠vel M√©dio (Volta)', range: [93, 111] }, 
                { titulo: 'üü¢ N√≠vel F√°cil (Volta)', range: [111, 141] } 
            ];

            grupos.forEach(grupo => {
                // Header da se√ß√£o (com bot√£o limpar)
                const tituloContainer = document.createElement('div');
                tituloContainer.className = 'section-title';
                
                const texto = document.createElement('span');
                texto.textContent = grupo.titulo;
                
                const btnLimpar = document.createElement('button');
                btnLimpar.className = 'btn-mini-clear';
                btnLimpar.textContent = 'Limpar Se√ß√£o';
                btnLimpar.onclick = () => limparIntervalo(grupo.range[0], grupo.range[1]);

                tituloContainer.appendChild(texto);
                tituloContainer.appendChild(btnLimpar);
                grid.appendChild(tituloContainer);

                // Cards da se√ß√£o
                const itensDaEtapa = dadosDesafio.slice(grupo.range[0], grupo.range[1]);

                itensDaEtapa.forEach((item, indexLocal) => {
                    const indexReal = grupo.range[0] + indexLocal;
                    
                    const card = document.createElement('div');
                    card.className = `card ${item.tipo} ${item.pago ? 'pago' : ''}`;
                    card.textContent = `R$ ${item.valor}`;
                    
                    if (item.pago) {
                        totalGuardado += item.valor;
                        diasPagos++;
                    }

                    card.onclick = () => {
                        dadosDesafio[indexReal].pago = !dadosDesafio[indexReal].pago;
                        salvarProgresso();
                    };

                    grid.appendChild(card);
                });
            });

            document.getElementById('displayTotal').textContent = totalGuardado.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            
            const pct = (diasPagos / totalDias) * 100;
            document.getElementById('barraProgresso').style.width = `${pct}%`;
            document.getElementById('progressoTexto').textContent = `${diasPagos} de ${totalDias} dias conclu√≠dos (${Math.round(pct)}%)`;
        }

        window.sairPerfil = function() {
            if(unsubscribe) unsubscribe();
            perfilAtual = null;
            dadosDesafio = [];
            dashboardScreen.style.display = 'none';
            loginScreen.style.display = 'flex';
            document.getElementById('profileInput').value = '';
            document.getElementById('passwordInput').value = '';
            alternarLoading(false);
        }
    </script>
</body>
</html>
